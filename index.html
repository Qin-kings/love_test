<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>情侣相册</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-2xl font-bold mb-4">情侣相册 💖</h1>

  <!-- 上传区 -->
  <input type="file" id="photoFiles" class="mb-4" multiple>
  <button onclick="startUpload()" class="px-4 py-2 bg-pink-400 text-white rounded-lg">上传</button>

  <!-- 相册展示 -->
  <div id="gallery" class="grid grid-cols-2 gap-4 w-full mt-6"></div>

  <script>
    const GH_OWNER = "Qin-kings";   // GitHub 用户名
    const GH_REPO  = "love_test";    // 仓库名
    const GH_TOKEN = "4f46b6c64682df2c534b71582906ddc5"; // ⚠️ 仅用于触发workflow，安全控制

    // Postimages 配置
    const PI_KEY     = "4f46b6c64682df2c534b71582906ddc5";
    const PI_GALLERY = "4pmmnyX";

    // 渲染相册
    async function refreshGallery() {
      const url = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/main/gallery.json`;
      const res = await fetch(url, {cache: "no-store"});
      if(!res.ok) return;
      const list = await res.json();
      const container = document.getElementById("gallery");
      container.innerHTML = "";
      list.slice().reverse().forEach(item => {
        const img = document.createElement("img");
        img.src = item.src;
        img.className = "w-full h-40 object-cover rounded-lg shadow";
        container.appendChild(img);
      });
    }

    // 文件转 base64
    function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result.split(",")[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // 上传到 Postimages
    async function uploadToPostimages({base64, fileName}){
      const form = new URLSearchParams();
      form.set("key", PI_KEY);
      form.set("gallery", PI_GALLERY);
      form.set("name", fileName);
      form.set("type", "base64");
      form.set("image", base64);

      const res = await fetch("https://api.postimages.org/1/upload", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: form.toString()
      });
      const data = await res.json();
      return data.url || data.image?.url || "";
    }

    // 上传入口
    async function startUpload(){
      const files = document.getElementById("photoFiles").files;
      if(files.length === 0) return alert("请选择文件");

      for(const f of files){
        const base64 = await fileToBase64(f);
        const url = await uploadToPostimages({base64, fileName: f.name});
        
        // 调用 GitHub Actions workflow
        await fetch(
          `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/actions/workflows/add_photo.yml/dispatches`,
          {
            method: "POST",
            headers: {
              "Accept": "application/vnd.github+json",
              "Authorization": `Bearer ${GH_TOKEN}`
            },
            body: JSON.stringify({
              ref: "main",
              inputs: { url }
            })
          }
        );
      }

      alert("上传成功 ✅，请稍等 Actions 更新 gallery.json");
      setTimeout(refreshGallery, 3000); // 延迟刷新
    }

    document.addEventListener("DOMContentLoaded", refreshGallery);
  </script>
</body>
</html>
